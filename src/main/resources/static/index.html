<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Quick Task Manager</title>
    <link rel="stylesheet" href="css/styles.css" />
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 20px;
        }
        header, nav {
            margin-bottom: 20px;
        }
        .modal {
            display: none;
            position: fixed;
            top: 10%;
            left: 50%;
            transform: translate(-50%, 0);
            background: #fff;
            padding: 20px;
            box-shadow: 0 0 10px gray;
            border-radius: 10px;
        }
        .modal.show {
            display: block;
        }
        .task-card {
            background: #f9f9f9;
            margin-bottom: 10px;
            padding: 10px;
            border-radius: 5px;
        }
    </style>
</head>
<body>
<header>
    <h1>Quick Task Manager</h1>
</header>

<nav>
    <button onclick="showAddTaskModal()">+ Add Task</button>
    <select id="statusFilter" onchange="filterTasks()">
        <option value="ALL">All</option>
        <option value="PENDING">Pending</option>
        <option value="COMPLETED">Completed</option>
    </select>
</nav>

<!-- Modal for adding task -->
<div id="taskModal" class="modal">
    <h2>Add New Task</h2>
    <form id="addTaskForm">
        <input type="text" id="title" placeholder="Title" required /><br/><br/>
        <input type="text" id="description" placeholder="Description" required /><br/><br/>
        <input type="date" id="dueDate" required /><br/><br/>
        <button type="submit">Add Task</button>
        <button type="button" onclick="closeAddTaskModal()">Cancel</button>
    </form>
</div>

<h2>Your Tasks</h2>
<div id="taskList"></div>

<script>
    const userEmail = localStorage.getItem("userEmail") || "demo@example.com"; // fallback for demo

    async function getUserIdByEmail(email) {
        const res = await fetch(`http://localhost:8080/users/email/${email}`);
        if (res.ok) {
            const user = await res.json();
            return user.id;
        } else {
            alert("Could not retrieve user");
            return null;
        }
    }

    async function loadTasks(userId) {
        const res = await fetch(`http://localhost:8080/users/${userId}/tasks`);
        const tasks = await res.json();

        const filter = document.getElementById("statusFilter").value;
        const container = document.getElementById("taskList");
        container.innerHTML = "";

        tasks
            .filter(task => filter === "ALL" || task.status === filter)
            .forEach(task => {
                container.innerHTML += `
            <div class="task-card">
              <strong>${task.title}</strong> - <em>${task.status}</em><br/>
              ${task.description}<br/>
              Due: ${task.dueDate}<br/>
              ${task.status === "PENDING" ? `<button onclick="markCompleted(${task.id})">Mark as Completed</button>` : ""}
            </div>
          `;
            });
    }

    async function markCompleted(taskId) {
        const res = await fetch(`http://localhost:8080/tasks/${taskId}/status?status=COMPLETED`, {
            method: "PUT",
        });

        if (res.ok) {
            alert("Task marked as completed");
            init();
        } else {
            alert("Failed to update task status");
        }
    }

    document.getElementById("addTaskForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const userId = await getUserIdByEmail(userEmail);

        const task = {
            title: document.getElementById("title").value,
            description: document.getElementById("description").value,
            dueDate: document.getElementById("dueDate").value,
        };

        const res = await fetch(`http://localhost:8080/users/${userId}/tasks`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(task),
        });

        if (res.ok) {
            alert("Task added");
            closeAddTaskModal();
            init();
        } else {
            alert("Failed to add task");
        }
    });

    function showAddTaskModal() {
        document.getElementById("taskModal").classList.add("show");
    }

    function closeAddTaskModal() {
        document.getElementById("taskModal").classList.remove("show");
    }

    function filterTasks() {
        init();
    }

    async function init() {
        const userId = await getUserIdByEmail(userEmail);
        if (userId) {
            loadTasks(userId);
        }
    }

    init();
</script>
</body>
</html>
